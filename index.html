<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArUco NSYNC</title>
    <style>
        body {
            margin: 0;
            padding: min(20px, 2vw);
            font-family: 'Consolas', 'Monaco', 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Courier New', monospace;
            background: white;
            color: black;
            font-weight: bold;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .info-panel {
            background: #f0f0f0;
            padding: min(25px, 3vw);
            border-radius: 8px;
            margin-bottom: min(30px, 3vh);
            font-size: min(20px, 3vw);
            flex-shrink: 0;
        }

        .timestamp {
            font-size: min(96px, 12vw, 8vh);
            font-weight: bold;
            margin-bottom: min(20px, 2vh);
        }

        .markers-container {
            display: grid;
            gap: min(60px, 4vw, 3vh);
            justify-content: center;
            align-items: center;
            padding: min(40px, 3vw);
            flex: 1;
            min-height: 0;
        }

        /* Single row for wide screens */
        @media (aspect-ratio > 1.3) {
            .markers-container {
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: 1fr;
            }
            .aruco-marker {
                width: min(400px, 20vw, 30vh);
                height: min(400px, 20vw, 30vh);
            }
        }

        /* 2x2 grid for narrow screens */
        @media (aspect-ratio <= 1.3) {
            .markers-container {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(2, 1fr);
            }
            .aruco-marker {
                width: min(300px, 35vw, 25vh);
                height: min(300px, 35vw, 25vh);
            }
        }

        .marker-group {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .marker-label {
            font-size: min(32px, 4vw, 3vh);
            font-weight: bold;
            margin-top: min(15px, 1vh);
        }

        .aruco-marker {
            border: min(6px, 0.5vw) solid black;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(7, 1fr);
            margin: 0 auto;
            flex-shrink: 0;
        }

        .marker-cell {
            border: 1px solid #ccc;
        }

        .marker-cell.black {
            background-color: black;
        }

        .marker-cell.white {
            background-color: white;
        }

        .fullscreen-button {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border: 1px solid black;
            background: white;
            cursor: pointer;
            font-size: 12px;
            z-index: 100;
        }

        .clapper-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border: 3px solid black;
            background: #ffdd00;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            z-index: 100;
            transition: all 0.1s ease;
            text-align: center;
            line-height: 1.2;
        }

        .clapper-button:hover {
            background: #ffcc00;
            transform: scale(1.05);
        }

        .clapper-button:active {
            transform: scale(0.95);
        }

        .clapper-active {
            animation: none !important;
        }

        .day-marker-corner {
            position: fixed;
            top: min(20px, 2vh);
            right: min(150px, 15vw);
            text-align: center;
            z-index: 50;
        }

        .day-marker-corner .marker-label {
            font-size: min(18px, 2.5vw, 2vh);
            font-weight: bold;
            margin-top: min(5px, 0.5vh);
            background: rgba(240, 240, 240, 0.9);
            padding: min(5px, 0.5vw);
            border-radius: 4px;
        }

        .day-marker-corner .aruco-marker {
            width: min(120px, 12vw, 10vh);
            height: min(120px, 12vw, 10vh);
            border: min(3px, 0.3vw) solid black;
        }
    </style>
</head>
<body>
    <button class="fullscreen-button" onclick="toggleFullscreen()">Fullscreen</button>
    <button class="clapper-button" onclick="triggerClapper()">ðŸŽ¬ CLAP<br><small>(or press Enter)</small></button>
    
    <div class="day-marker-corner">
        <div class="aruco-marker" id="dayMarker"></div>
        <div class="marker-label">Day: <span id="dayValue"></span></div>
    </div>
    
    <div class="info-panel">
        <div class="timestamp" id="timestamp"></div>
        <div>Screen Resolution: <span id="resolution"></span></div>
        <div>Main Markers: 4 Ã— <span id="markerSize">400Ã—400</span> pixels | Corner Marker: <span id="cornerMarkerSize">120Ã—120</span> pixels</div>
        <div>Device Pixel Ratio: <span id="pixelRatio"></span></div>
        <div>Timezone: <span id="timezone"></span></div>
    </div>

    <div class="markers-container">
        <div class="marker-group">
            <div class="aruco-marker" id="hourMarker"></div>
            <div class="marker-label">Hour: <span id="hourValue"></span></div>
        </div>

        <div class="marker-group">
            <div class="aruco-marker" id="minuteMarker"></div>
            <div class="marker-label">Minute: <span id="minuteValue"></span></div>
        </div>

        <div class="marker-group">
            <div class="aruco-marker" id="secondMarker"></div>
            <div class="marker-label">Second: <span id="secondValue"></span></div>
        </div>

        <div class="marker-group">
            <div class="aruco-marker" id="millisecondMarker"></div>
            <div class="marker-label">Millisecond: <span id="millisecondValue"></span></div>
        </div>
    </div>

    <script>
        let audioContext = null;
        let clapperActive = false;
        let syncEventLog = [];

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        function playTone(frequency = 800, duration = 150, volume = 0.3) {
            const ctx = initAudioContext();
            
            // Create oscillator for tone
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            // Connect nodes
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            // Configure tone
            oscillator.frequency.setValueAtTime(frequency, ctx.currentTime);
            oscillator.type = 'sine';
            
            // Configure volume envelope
            gainNode.gain.setValueAtTime(0, ctx.currentTime);
            gainNode.gain.linearRampToValueAtTime(volume, ctx.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration / 1000);
            
            // Play tone
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + duration / 1000);
        }

        function generateCSV(syncData) {
            const headers = ['event_index', 'event_type', 'unix_timestamp', 'offset_ms', 'color', 'frequency_hz', 'audio_cue'];
            const rows = [headers.join(',')];
            
            syncData.forEach((event, index) => {
                const row = [
                    index + 1,
                    `"${event.type}"`,
                    event.timestamp,
                    event.offset,
                    `"${event.color}"`,
                    event.frequency || '',
                    event.audio ? 'TRUE' : 'FALSE'
                ];
                rows.push(row.join(','));
            });
            
            return rows.join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function triggerClapper() {
            if (clapperActive) return; // Prevent multiple simultaneous triggers
            
            clapperActive = true;
            syncEventLog = []; // Reset event log
            const clapStartTime = Date.now();
            const originalBg = document.body.style.backgroundColor;
            
            // Main sequence timing (in milliseconds) - reliable across all devices
            const mainSequence = [
                { time: 0, color: '#ffff00', frequency: 600, type: 'prep_yellow', audio: true },
                { time: 500, color: '#ff8800', frequency: 800, type: 'prep_orange', audio: true },  
                { time: 1000, color: '#ff0000', frequency: 1000, type: 'sync_main', audio: true }
            ];
            
            // High-precision micro-sequence after main sync point
            const microSequence = [
                { time: 1000, color: '#ff0000', type: 'sync_main', audio: false },
                { time: 1033, color: '#00ff00', type: 'micro_green_1', audio: true },
                { time: 1066, color: '#0088ff', type: 'micro_blue_1', audio: false },
                { time: 1100, color: '#00ff00', type: 'micro_green_2', audio: true },
                { time: 1133, color: '#0088ff', type: 'micro_blue_2', audio: false },
                { time: 1167, color: '#00ff00', type: 'micro_green_3', audio: true },
                { time: 1200, color: 'white', type: 'sequence_end', audio: false }
            ];
            
            // Record sync timestamp at the main sync point (red)
            const syncTimestamp = clapStartTime + 1000;
            
            // Execute main sequence with audio and logging
            mainSequence.forEach(step => {
                setTimeout(() => {
                    const actualTime = Date.now();
                    document.body.style.backgroundColor = step.color;
                    
                    // Log event
                    syncEventLog.push({
                        type: step.type,
                        timestamp: actualTime,
                        offset: actualTime - clapStartTime,
                        color: step.color,
                        frequency: step.frequency,
                        audio: step.audio
                    });
                    
                    if (step.frequency) {
                        playTone(step.frequency, 150, 0.5);
                    }
                    
                    // Log sync point
                    if (step.color === '#ff0000') {
                        console.log(`CLAPPER SYNC: ${actualTime}ms Unix: ${actualTime}`);
                    }
                }, step.time);
            });
            
            // Execute main sequence with audio
            mainSequence.forEach(step => {
                setTimeout(() => {
                    document.body.style.backgroundColor = step.color;
                    
                    if (step.frequency) {
                        playTone(step.frequency, 150, 0.5);
                    }
                    
                    // Log sync point
                    if (step.color === '#ff0000') {
                        console.log(`CLAPPER SYNC: ${syncTimestamp}ms Unix: ${syncTimestamp}`);
                    }
                }, step.time);
            });
            
            // Execute high-precision micro-sequence using requestAnimationFrame
            let microIndex = 0;
            const executeMicroSequence = () => {
                if (microIndex < microSequence.length) {
                    const step = microSequence[microIndex];
                    const elapsed = Date.now() - clapStartTime;
                    
                    if (elapsed >= step.time) {
                        const actualTime = Date.now();
                        document.body.style.backgroundColor = step.color;
                        
                        // Log micro-sequence event (skip duplicate main sync)
                        if (step.type !== 'sync_main' || microIndex === 0) {
                            syncEventLog.push({
                                type: step.type,
                                timestamp: actualTime,
                                offset: actualTime - clapStartTime,
                                color: step.color,
                                frequency: step.audio && step.color === '#00ff00' ? 1400 : null,
                                audio: step.audio
                            });
                        }
                        
                        // Add audio cues for green flashes only
                        if (step.color === '#00ff00') {
                            playTone(1400, 50, 0.2);
                        }
                        
                        console.log(`Micro-flash ${microIndex + 1}: ${actualTime}ms (${elapsed}ms from start) - ${step.color}`);
                        microIndex++;
                        
                        // Reset clapper state and save CSV when sequence ends
                        if (step.color === 'white') {
                            clapperActive = false;
                            
                            // Generate and download CSV
                            const csvContent = generateCSV(syncEventLog);
                            const filename = `clapper_sync_${clapStartTime}.csv`;
                            downloadCSV(csvContent, filename);
                            
                            console.log(`ðŸ“Š Sync data saved: ${filename}`);
                            console.log(`ðŸ“‹ Total events logged: ${syncEventLog.length}`);
                            return;
                        }
                    }
                    requestAnimationFrame(executeMicroSequence);
                }
            };
            
            // Start micro-sequence at the main sync point
            setTimeout(() => {
                requestAnimationFrame(executeMicroSequence);
            }, 1000);
        }

        function generateMarkerPattern(value) {
            const binary = value.toString(2).padStart(25, '0');
            const pattern = Array(7).fill().map(() => Array(7).fill(1));
            
            // Fill inner 5x5 area with binary pattern
            for (let i = 0; i < 5; i++) {
                for (let j = 0; j < 5; j++) {
                    pattern[i + 1][j + 1] = parseInt(binary[i * 5 + j]);
                }
            }
            return pattern;
        }

        function renderMarker(containerId, pattern) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            pattern.flat().forEach(cell => {
                const div = document.createElement('div');
                div.className = `marker-cell ${cell ? 'black' : 'white'}`;
                container.appendChild(div);
            });
        }

        function updateDisplay() {
            const now = new Date();
            const timestamp = now.getTime();
            
            document.getElementById('timestamp').textContent = `Unix: ${timestamp}`;
            
            const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const hour = now.getHours();
            const minute = now.getMinutes();
            const second = now.getSeconds();
            const millisecond = now.getMilliseconds();
            
            document.getElementById('dayValue').textContent = dayOfYear;
            document.getElementById('hourValue').textContent = hour;
            document.getElementById('minuteValue').textContent = minute;
            document.getElementById('secondValue').textContent = second;
            document.getElementById('millisecondValue').textContent = millisecond;
            
            renderMarker('dayMarker', generateMarkerPattern(dayOfYear));
            renderMarker('hourMarker', generateMarkerPattern(hour));
            renderMarker('minuteMarker', generateMarkerPattern(minute));
            renderMarker('secondMarker', generateMarkerPattern(second));
            renderMarker('millisecondMarker', generateMarkerPattern(millisecond));
        }

        function updateScreenInfo() {
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const aspectRatio = windowWidth / windowHeight;
            
            let markerSize, cornerMarkerSize;
            
            if (aspectRatio > 1.3) {
                // Wide screen - single row
                markerSize = Math.min(400, windowWidth * 0.20, windowHeight * 0.30);
            } else {
                // Narrow screen - 2x2 grid
                markerSize = Math.min(300, windowWidth * 0.35, windowHeight * 0.25);
            }
            
            cornerMarkerSize = Math.min(120, windowWidth * 0.12, windowHeight * 0.10);
            
            document.getElementById('resolution').textContent = `${windowWidth}Ã—${windowHeight}`;
            document.getElementById('markerSize').textContent = `${Math.round(markerSize)}Ã—${Math.round(markerSize)}`;
            document.getElementById('cornerMarkerSize').textContent = `${Math.round(cornerMarkerSize)}Ã—${Math.round(cornerMarkerSize)}`;
            document.getElementById('pixelRatio').textContent = devicePixelRatio || 1;
            document.getElementById('timezone').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(() => {});
            } else {
                document.exitFullscreen();
            }
        }

        updateScreenInfo();
        updateDisplay();
        setInterval(updateDisplay, 10);
        
        // Update screen info when window is resized
        window.addEventListener('resize', updateScreenInfo);
        
        // Initialize audio context on first user interaction
        document.addEventListener('click', () => {
            initAudioContext();
        }, { once: true });
        
        // Add keyboard support for clapper (Enter key)
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault();
                triggerClapper();
            }
        });
    </script>
</body>
</html>